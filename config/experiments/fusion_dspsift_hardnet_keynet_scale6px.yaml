# DSPSIFT + HardNet Fusion - Fair Comparison Methodology
#
# Tests whether DSPSIFT (pyramid-aware domain-size pooling, 57.25% mAP baseline)
# provides better fusion with HardNet compared to vanilla SIFT.
#
# Follows the same experimental design as fair_fusion_sift_hardnet_comprehensive.yaml:
# - Phase 1: Uncontrolled baselines (full keypoint sets)
# - Phase 2: Scale-controlled baselines (top-N by size)
# - Phase 3: Spatial intersection baselines (individual descriptors)
# - Phase 4: Fusion on original spatial intersection
# - Phase 5: Fusion on scale-matched intersection
#
# Expected Runtime: ~6-8 hours for all 8 DSPSIFT descriptor configurations

experiment:
  name: "fusion_dspsift+hardnet_sift_full_scale6px_keynet_intersections"
  description: "DSPSIFT + HardNet fusion with fair comparison methodology across both intersection types"

dataset:
  type: "hpatches"
  path: "../data/"
  scenes: []  # All 116 scenes

keypoints:
  source: "database"
  keypoint_set_name: "independent"  # Explicit assignment mode
  use_locked_keypoints: true

  alternative_keypoints:
    # ===== PHASE 1: UNCONTROLLED BASELINES =====
    - keypoint_set_name: "sift_8000"
      description: "Full SIFT keypoints (2.5M keypoints, avg 4.45px) - uncontrolled scale"

    # ===== PHASE 2: SCALE-CONTROLLED BASELINES =====
    - keypoint_set_name: "sift_scale_matched_6px"
      description: "SIFT top 25% by size (645K keypoints, avg 10.03px) - scale-controlled"

    # ===== PHASE 3: SPATIAL INTERSECTION SETS (FROM FULL SETS) =====
    - keypoint_set_name: "keynet_sift_8k_b"
      description: "SIFT positions from SIFT-KeyNet intersection (565K, avg 3.51px)"

    - keypoint_set_name: "keynet_sift_8k_a"
      description: "KeyNet positions from SIFT-KeyNet intersection (565K, avg 45.93px)"

    # ===== PHASE 5: SCALE-MATCHED INTERSECTION =====
    - keypoint_set_name: "sift_keynet_scale_matched_intersection_a"
      description: "SIFT positions from scale-matched intersection (111K, avg 7.64px)"

    - keypoint_set_name: "sift_keynet_scale_matched_intersection_b"
      description: "KeyNet positions from scale-matched intersection (111K, avg 89.74px)"

descriptors:
  # ===================================================================
  # PHASE 1: UNCONTROLLED BASELINE
  # Purpose: Establish DSPSIFT performance on full keypoint set
  # ===================================================================

  - name: "dspsift_v2__sift_8000__native"
    type: "dspsift_v2"
    keypoint_set_name: "sift_8000"
    pooling: "none"                     # DSP pooling is built-in!
    pooling_aggregation: "average"
    scales: [0.85, 1.0, 1.3]
    normalize_after_pooling: true
    norm_type: 2                        # L2 normalization
    rooting_stage: "none"
    use_color: false
    # Expected: Test if DSPSIFT maintains ~57.25% on full set
    # Compare to phase1_sift_native: 42.6%

  # ===================================================================
  # PHASE 2: SCALE-CONTROLLED BASELINE
  # Purpose: Test if scale control improves DSPSIFT like it did SIFT (+50%)
  # ===================================================================

  - name: "dspsift_v2__sift_scale_matched_6px__scale_controlled"
    type: "dspsift_v2"
    keypoint_set_name: "sift_scale_matched_6px"
    pooling: "none"                     # DSP pooling is built-in!
    pooling_aggregation: "average"
    scales: [0.85, 1.0, 1.3]
    normalize_after_pooling: true
    norm_type: 2
    rooting_stage: "none"
    use_color: false
    # Expected: > 57.25% if scale control helps DSPSIFT
    # Compare to phase2_sift_scale_controlled: 63.9%

  # ===================================================================
  # PHASE 3: SPATIAL INTERSECTION BASELINE
  # Purpose: Test if spatial intersection helps DSPSIFT
  # ===================================================================

  - name: "dspsift_v2__keynet_sift_8k_b__intersection"
    type: "dspsift_v2"
    keypoint_set_name: "keynet_sift_8k_b"
    pooling: "none"                     # DSP pooling is built-in!
    pooling_aggregation: "average"
    scales: [0.85, 1.0, 1.3]
    normalize_after_pooling: true
    norm_type: 2
    rooting_stage: "none"
    use_color: false
    # Expected: Test intersection benefit for DSPSIFT
    # Compare to phase3_sift_on_intersection: 55.2%

  # ===================================================================
  # PHASE 4: FUSION ON ORIGINAL SPATIAL INTERSECTION
  # Purpose: Test DSPSIFT + HardNet fusion on uncontrolled intersection
  # ===================================================================

  - name: "fusion_dspsift+hardnet__keynet_sift_8k_a+b__weighted_avg"
    type: "composite"
    components:
      - descriptor: "dspsift_v2"
        keypoint_set_name: "keynet_sift_8k_b"
        pooling: "none"                 # DSP pooling is built-in!
        pooling_aggregation: "average"
        scales: [0.85, 1.0, 1.3]
        normalize_after_pooling: true
        norm_type: 2
        rooting_stage: "none"
        use_color: false
        weight: 0.5
      - descriptor: "libtorch_hardnet"
        device: "auto"
        keypoint_set_name: "keynet_sift_8k_a"
        weight: 0.5
    aggregation: "weighted_avg"
    # Expected: Will DSPSIFT avoid being dominated like SIFT was?
    # Compare to phase4_fusion_intersection_avg (SIFT): 55.2% (FAILED)

  - name: "fusion_dspsift+hardnet__keynet_sift_8k_a+b__concatenate"
    type: "composite"
    components:
      - descriptor: "dspsift_v2"
        keypoint_set_name: "keynet_sift_8k_b"
        pooling: "none"                 # DSP pooling is built-in!
        pooling_aggregation: "average"
        scales: [0.85, 1.0, 1.3]
        normalize_after_pooling: true
        norm_type: 2
        rooting_stage: "none"
        use_color: false
      - descriptor: "libtorch_hardnet"
        device: "auto"
        keypoint_set_name: "keynet_sift_8k_a"
    aggregation: "concatenate"
    # Test concatenation on original intersection

  # ===================================================================
  # PHASE 5: FUSION ON SCALE-MATCHED INTERSECTION
  # Purpose: CRITICAL - Test if DSPSIFT fusion works with scale matching
  # ===================================================================

  - name: "fusion_dspsift+hardnet__sift_keynet_scale_matched_intersection_a+b__weighted_avg"
    type: "composite"
    components:
      - descriptor: "dspsift_v2"
        keypoint_set_name: "sift_keynet_scale_matched_intersection_a"
        pooling: "none"                 # DSP pooling is built-in!
        pooling_aggregation: "average"
        scales: [0.85, 1.0, 1.3]
        normalize_after_pooling: true
        norm_type: 2
        rooting_stage: "none"
        use_color: false
        weight: 0.5
      - descriptor: "libtorch_hardnet"
        device: "auto"
        keypoint_set_name: "sift_keynet_scale_matched_intersection_b"
        weight: 0.5
    aggregation: "weighted_avg"
    # Expected: > 72.5% (SIFT fusion) if DSPSIFT better partner
    # Compare to phase5_fusion_scale_matched_avg (SIFT): 72.5%

  - name: "fusion_dspsift+hardnet__sift_keynet_scale_matched_intersection_a+b__concatenate"
    type: "composite"
    components:
      - descriptor: "dspsift_v2"
        keypoint_set_name: "sift_keynet_scale_matched_intersection_a"
        pooling: "none"                 # DSP pooling is built-in!
        pooling_aggregation: "average"
        scales: [0.85, 1.0, 1.3]
        normalize_after_pooling: true
        norm_type: 2
        rooting_stage: "none"
        use_color: false
      - descriptor: "libtorch_hardnet"
        device: "auto"
        keypoint_set_name: "sift_keynet_scale_matched_intersection_b"
    aggregation: "concatenate"
    # Test concatenation on scale-matched intersection

evaluation:
  matching:
    method: "ratio_test"
    norm: "l2"
    cross_check: true
    ratio_threshold: 0.8

  validation:
    method: "homography"
    threshold: 0.05
    min_matches: 10

  keypoint_verification:
    enabled: false

  keypoint_retrieval:
    enabled: false

performance:
  parallel_scenes: true
  num_threads: 0  # Auto-detect CPU cores
  batch_size: 512

database:
  connection: "sqlite:///experiments.db"
  save_descriptors: false
  save_matches: false
  save_visualizations: false

# ===================================================================
# EXPECTED OUTCOMES AND INTERPRETATION
# ===================================================================
#
# Key Comparisons:
#
# 1. DSPSIFT vs SIFT baselines:
#    - Phase 1: DSPSIFT native vs SIFT native (42.6%)
#    - Phase 2: DSPSIFT scale-controlled vs SIFT scale-controlled (63.9%)
#    - Phase 3: DSPSIFT intersection vs SIFT intersection (55.2%)
#
# 2. Fusion comparisons:
#    - Phase 4: DSPSIFT fusion (uncontrolled) vs SIFT fusion (55.2% - FAILED)
#    - Phase 5: DSPSIFT fusion (scale-matched) vs SIFT fusion (72.5%)
#
# 3. Critical test:
#    - phase5_dspsift_fusion_scale_matched_avg vs HardNet alone (78.9%)
#    - If > 78.9%: SUCCESS! DSPSIFT complements HardNet
#    - If 72-78%: Improvement over SIFT but still dominated
#    - If â‰ˆ 72%: No better than SIFT, multi-scale doesn't help fusion
#
# Hypotheses:
# H1: DSPSIFT multi-scale pooling provides richer features
# H2: DSPSIFT baseline (~57%) still weaker than HardNet (78.9%)
# H3: Multi-scale may reduce HardNet dominance in fusion
# H4: Phase 4 will likely fail (small-scale dominance)
# H5: Phase 5 is the critical test
#
# See docs/StatusDocs/INTERSECTION_MAP_INVESTIGATION_RESULTS.md
# ===================================================================
